# language: yaml
#
# Github workflow to automate my release process
#
# User must manually trigger the workflow via "Actions" and
# supply a version number
#
---

name: Create release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version (e.g. 1.2.3)'
        required: true
      ## Don't try to deal with change log at this point
      #changes:
      #  description: 'Optional changelog entries (markdown or bullet list)'
      #  required: false

permissions:
  contents: write
  pull-requests: write
  issues: write
  checks: read

concurrency:
  group: create-release-${{ github.event.inputs.version }}
  cancel-in-progress: false

jobs:
  make-pull-request:
    runs-on: ubuntu-latest
    outputs:
      pr-number: ${{ steps.cpr.outputs.pull-request-number }}
    env:
      VERSION: ${{ github.event.inputs.version }}
      ##CHANGES: ${{ github.event.inputs.changes }}
    steps:

      - name: Checkout repo
        uses: actions/checkout@v6

      - name: Update package version
        run: |
          echo "Updating version to $VERSION"
          echo "Current directory: $(pwd)"
          echo "Contents: $(ls -l)"
          sed -i "s/^__version__ = .*/__version__ = \"$VERSION\"/" pbtbx/__init__.py

      # NB Ensure that Settings -> Actions -> General on Github
      # allows Github Actions to create and approve pull requests
      # otherwise this step will fail
      - name: Create pull request for release
        id: cpr
        uses: peter-evans/create-pull-request@v8.1.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          commit-message: "chore: bump version to ${{ env.VERSION }}"
          base: devel
          branch: version-${{ env.VERSION }}
          title: "pbtbx version ${{ env.VERSION }}"
          body: "Automated release PR for new version ${{ env.VERSION }}"

      - name: Add "release" label to PR
        if: steps.cpr.outputs.pull-request-number
        uses: actions-ecosystem/action-add-labels@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          number: ${{ steps.cpr.outputs.pull-request-number }}
          labels: release

      # NB By default one workflow won't trigger another
      # (so the Python CI workflow won't be initiated by the
      # pull request created above)

  merge-and-tag:
    runs-on: ubuntu-latest
    needs: make-pull-request
    env:
      VERSION: ${{ github.event.inputs.version }}
    steps:
      - name: Checkout repo with all branches and history
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Merge and delete pull request
        run: |
          gh pr merge --merge --auto "${{ needs.make-pull-request.outputs.pr-number }}" --delete-branch
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Merge changes from devel into master
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git fetch --all
          git pull --ff-only
          git checkout -t -b master origin/master
          git merge devel

      - name: Tag release
        run: |
          git tag -a -m "Release ${{ env.VERSION }}" "v${{ env.VERSION }}"

      - name: Push changes
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: "master"

      # See https://cli.github.com/manual/gh_release_create
      - name: Make release from tag
        run: |
          gh release create "v${{ env.VERSION }}" --target master --verify-tag --title "pbtbx ${{ env.VERSION }}" --generate-notes
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
